name: Build Lambda Chrome Layer

on:
  push:
    branches:
      - main

jobs:
  build-layer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Chromium + ChromeDriver layer
        run: |
          mkdir -p layer/bin

          # Download newest headless Chrome
          curl -Lo /tmp/chrome-linux.zip "https://storage.googleapis.com/chrome-for-testing/latest/linux64/chrome-linux.zip"
          unzip /tmp/chrome-linux.zip -d layer/bin

          # Download newest ChromeDriver matching Chrome version
          # Extract version number from Chrome
          CHROME_VER=$(unzip -p /tmp/chrome-linux.zip chrome-linux/ProductVersion)
          CHROMEDRIVER_URL="https://chromedriver.storage.googleapis.com/${CHROME_VER}/chromedriver_linux64.zip"
          curl -Lo /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
          unzip /tmp/chromedriver.zip -d layer/bin

          chmod +x layer/bin/chrome-linux/chrome
          chmod +x layer/bin/chromedriver

          # Create zip
          cd layer
          zip -r ../chrome-layer.zip .
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-layer
          path: chrome-layer.zip
